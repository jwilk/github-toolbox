#!/bin/bash

# Copyright Â© 2017 Jakub Wilk <jwilk@jwilk.net>
# SPDX-License-Identifier: MIT

usage()
{
    printf 'Usage: %s <reaction> <url>\n' "$0"
    printf 'Reactions: +1 -1 :D :/ <3 \o/\n'
    printf 'URLs: https://github.com/<owner>/<repo>/issues/<n>\n'
}

set -e -u
cacert=$(git -C / config --get-urlmatch http.sslCAInfo https://api.github.com/)
github_token=$(sed -n -r -e 's/token\s*=\s*//p' "${XDG_DATA_HOME:-$HOME/.config}"/cligh/cligh.conf)
if [ $# -ne 2 ]
then
    usage >&2
    exit 1
fi
reaction="$1"
url="$2"
if [ "$reaction" = '+1' ] || [ "$reaction" = '-1' ]
then
    :
elif [ "$reaction" = ":D" ]
then
    reaction=laugh
elif [ "$reaction" = ":/" ]
then
    reaction=confused
elif [ "$reaction" = "<3" ]
then
    reaction=heart
elif [ "$reaction" = "\o/" ]
then
    reaction=hooray
else
    usage >&2
    exit 1
fi
if expr "$url" : 'https://github.com/[^/]\+/[^/]\+/issues/[0-9]\+$' > /dev/null
then
    owner=$(printf '%s' "$url" | cut -d / -f 4)
    repo=$(printf '%s' "$url" | cut -d / -f 5)
    number=$(printf '%s' "$url" | cut -d / -f 7)
else
    usage >&2
    exit 1
fi
url="https://api.github.com/repos/$owner/$repo/issues/$number/reactions"
json='{"content":"'"$reaction"'"}'
printf '%s %s\n' POST "$url"
curl \
    --silent --fail --show-error \
    --cacert "$cacert" \
    -K <(printf "header = \"Authorization: token %s\"\n" "$github_token") \
    -H 'User-Agent: github-toolbox (https://github.com/jwilk/github-toolbox)' \
    -H 'Accept: application/vnd.github.squirrel-girl-preview' \
    -X POST \
    --data "$json" \
    "$url" > /dev/null

# vim:ts=4 sts=4 sw=4 et
